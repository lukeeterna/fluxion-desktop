# E2E Test Workflow
# Enterprise-grade E2E testing pipeline for FLUXION

name: E2E Tests

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - critical
          - visual
          - a11y

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  BASE_URL: http://localhost:1420

jobs:
  # ============================================
  # Smoke Tests (Fast, runs on every push)
  # ============================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm ci
          cd e2e-tests && npm ci

      - name: Install Playwright
        run: cd e2e-tests && npx playwright install --with-deps chromium

      - name: Build App
        run: npm run build

      - name: Start App
        run: |
          npm run preview &
          npx wait-on http://localhost:1420 --timeout 60000

      - name: Run Smoke Tests
        run: cd e2e-tests && npm run test:smoke

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: |
            e2e-tests/reports/
            e2e-tests/test-results/
          retention-days: 7

  # ============================================
  # Full E2E Suite (Matrix: macOS, Windows)
  # ============================================
  e2e-full:
    name: E2E Full - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    needs: smoke-tests
    if: github.event_name == 'push' || github.event.inputs.test_suite == 'all'

    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Install Dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          npm ci
          cd e2e-tests && npm ci

      - name: Install Dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          npm ci
          cd e2e-tests && npm ci

      - name: Install Playwright
        run: cd e2e-tests && npx playwright install --with-deps

      - name: Build Tauri App
        run: npm run tauri build -- --debug

      - name: Run E2E Tests
        run: |
          cd e2e-tests
          npm run test:ci
        env:
          CI: true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ matrix.os }}
          path: |
            e2e-tests/reports/
            e2e-tests/test-results/
            e2e-tests/.allure-results/
          retention-days: 14

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.os }}
          path: e2e-tests/reports/html/
          retention-days: 14

  # ============================================
  # Visual Regression Tests
  # ============================================
  visual-tests:
    name: Visual Regression
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: smoke-tests
    if: github.event_name == 'pull_request' || github.event.inputs.test_suite == 'visual'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm ci
          cd e2e-tests && npm ci

      - name: Install Playwright
        run: cd e2e-tests && npx playwright install --with-deps chromium

      - name: Build App
        run: npm run build

      - name: Start App
        run: |
          npm run preview &
          npx wait-on http://localhost:1420 --timeout 60000

      - name: Run Visual Tests
        run: cd e2e-tests && npm run test:visual

      - name: Upload Visual Diff
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-diff
          path: e2e-tests/test-results/
          retention-days: 7

  # ============================================
  # Accessibility Tests
  # ============================================
  a11y-tests:
    name: Accessibility (WCAG 2.1 AA)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: smoke-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm ci
          cd e2e-tests && npm ci

      - name: Install Playwright
        run: cd e2e-tests && npx playwright install --with-deps chromium

      - name: Build App
        run: npm run build

      - name: Start App
        run: |
          npm run preview &
          npx wait-on http://localhost:1420 --timeout 60000

      - name: Run Accessibility Tests
        run: cd e2e-tests && npm run test:a11y

      - name: Upload A11y Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: a11y-report
          path: e2e-tests/reports/
          retention-days: 7

  # ============================================
  # Generate Allure Report
  # ============================================
  allure-report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: [e2e-full]
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          path: allure-results
          pattern: e2e-results-*
          merge-multiple: true

      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results/.allure-results
          allure_report: allure-report
          gh_pages: gh-pages
          allure_history: allure-history

      - name: Deploy Report to GitHub Pages
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          publish_branch: gh-pages
          destination_dir: allure-report

  # ============================================
  # Summary
  # ============================================
  e2e-summary:
    name: E2E Summary
    runs-on: ubuntu-latest
    needs: [smoke-tests, e2e-full, visual-tests, a11y-tests]
    if: always()

    steps:
      - name: Check Results
        run: |
          echo "## E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Full | ${{ needs.e2e-full.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Visual | ${{ needs.visual-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| A11y | ${{ needs.a11y-tests.result }} |" >> $GITHUB_STEP_SUMMARY
